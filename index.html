<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Money Tracking App</title>
    <link rel="icon" type="image/png" href="public/images/logo.png" />
    <link rel="stylesheet" href="public/styles/base.css" />
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header>
        <img src="public/images/logo.png" alt="Logo" class="logo" />
        <div class="title-warp">
          <h1>Money Tracking App</h1>
          <p>Qu·∫£n l√Ω chi ti√™u hi·ªáu qu·∫£</p>
        </div>
        <div class="head-action-warp">
          <button class="head-action-button focus-ring fade" id="btnSettings">
            C√†i ƒë·∫∑t
          </button>
          <button class="head-action-button focus-ring fade" id="btnLogin">
            ƒêƒÉng nh·∫≠p
          </button>
        </div>
      </header>

      <!-- Summary Card -->
      <section class="summaryGrid">
        <div class="summaryCard">
          <p id="lblToday">H√¥m nay</p>
          <p id="sumToday" class="mt-1 text-xl font-semibold">0 VND</p>
        </div>
        <div class="summaryCard">
          <p id="lblTomorrow">Ng√†y mai</p>
          <p id="sumTomorrow" class="mt-1 text-xl font-semibold">0 VND</p>
        </div>
        <div class="summaryCard">
          <p id="lblThisWeek">Tu·∫ßn n√†y</p>
          <p id="sumWeek" class="mt-1 text-xl font-semibold">0 VND</p>
        </div>
        <div class="summaryCard">
          <p id="lblThisMonth">Th√°ng n√†y</p>
          <p id="sumMonth" class="mt-1 text-xl font-semibold">0 VND</p>
        </div>
      </section>

      <!-- Filters & Actions -->
      <section class="filters-actions">
        <div class="search-box">
          <label id="lblSearch" class="lblSearch" for="search">T√¨m ki·∫øm</label>
          <input
            type="text"
            id="search"
            class="search-input focus-ring fade"
            placeholder="Ghi ch√∫, kh√°ch h√†ng, ngu·ªìn, ..."
          />
        </div>
        <div class="actions">
          <div class="action-item">
            <label id="lblFrom" for="fromDate">T·ª´ ng√†y</label>
            <input type="date" id="fromDate" class="focus-ring fade" />
          </div>
          <div class="action-item">
            <label id="lblTo" for="toDate">ƒê·∫øn ng√†y</label>
            <input type="date" id="toDate" class="focus-ring fade" />
          </div>
          <div class="action-item">
            <label id="lblSort" for="sort">S·∫Øp x·∫øp</label>
            <select id="sort" class="focus-ring fade">
              <option id="optNewest" value="newest">M·ªõi nh·∫•t</option>
              <option id="optOldest" value="oldest">C≈© nh·∫•t</option>
              <option id="optAmountDesc" value="amountDesc">S·ªë ti·ªÅn ‚Üì</option>
              <option id="optAmountAsc" value="amountAsc">S·ªë ti·ªÅn ‚Üë</option>
            </select>
          </div>
          <!-- B·∫°n c√≥ th·ªÉ ƒë·ªïi c√°c n√∫t n√†y th√†nh Export/Import khi c·∫ßn -->
          <div class="action-item">
            <button id="btnClearFilters" class="action-button focus-ring fade">Xo√° l·ªçc</button>
          </div>
        </div>
      </section>

      <!-- Select & delete bar -->
      <div class="select-delete">
        <span class="lblSelectedCount" id="lblSelectedCount">0 m·ª•c ƒë√£ ch·ªçn</span>
        <div class="select-delete-button-group">
          <button id="btnSelectAll" class="select-all-button focus-ring fade">
            Ch·ªçn t·∫•t c·∫£ (trang hi·ªán t·∫°i)
          </button>
          <button id="btnDeleteSelected" class="delete-selected-button focus-ring fade">
            X√≥a ƒë√£ ch·ªçn
          </button>
        </div>
      </div>

      <!-- Entries -->
      <section class="mt-4" id="entries"></section>

      <!-- Floating Add Button -->
      <button id="fab" title="Add Tip" class="fab focus-ring fade">
        + Th√™m tip
      </button>
    </div>

    <!-- modal entry -->
    <dialog id="entryDialog">
      <form method="dialog" id="entryForm">
        <div class="dlg-head">
          <h2 id="dialogTitle" class="dlg-title">Th√™m tip</h2>
          <p class="dlg-sub">
            Quy t·∫Øc ng√†y: <span id="logicDesc" style="font-weight: 600">Ghi cho ng√†y mai</span>
          </p>
        </div>

        <div class="dlg-body">
          <input type="hidden" id="entryId" />

          <!-- S·ªë ti·ªÅn -->
          <div class="field">
            <label id="lblAmount" class="flabel" for="amount">S·ªë ti·ªÅn (VND)</label>
            <div class="amount">
              <input
                id="amount"
                inputmode="numeric"
                placeholder="0"
                class="amount-prefix focus-ring fade"
              />
            </div>
            <div class="quick-buttons">
              <button type="button" data-quick="50000" class="quick focus-ring fade">+50k</button>
              <button type="button" data-quick="100000" class="quick focus-ring fade">+100k</button>
              <button type="button" data-quick="200000" class="quick focus-ring fade">+200k</button>
            </div>
          </div>

          <!-- Ng√†y nh·∫≠p + ng√†y t√≠nh -->
          <div class="field">
            <label id="lblInputDate" class="flabel" for="inputDate">Ng√†y nh·∫≠p (h√¥m nay)</label>
            <input id="inputDate" type="date" class="inputDate focus-ring fade" />
            <div class="record">
              <label class="pill">
                <input id="recordTomorrow" type="checkbox" style="width: 16px; height: 16px" />
                <span id="lblRecordTomorrow" style="font-size: 14px">Ghi cho ng√†y mai (m·∫∑c ƒë·ªãnh)</span>
              </label>
              <div class="muted">
                <span id="lblIntendedLabel">Ng√†y t√≠nh:</span>
                <span id="intendedPreview">‚Äî</span>
              </div>
            </div>

            <div class="field">
              <label id="lblOverride" class="flabel" for="intendedDate">Ch·ªânh ng√†y t√≠nh (tu·ª≥ ch·ªçn)</label>
              <input id="intendedDate" type="date" class="intendedDate focus-ring fade" />
              <p id="lblOverrideDesc" class="muted">M·∫∑c ƒë·ªãnh: ng√†y t√≠nh = ng√†y nh·∫≠p + 1 khi b·∫≠t "Ghi cho ng√†y mai".</p>
            </div>
          </div>

          <!-- Ngu·ªìn -->
          <div class="field">
            <label id="lblSource" class="flabel" for="source">Ngu·ªìn</label>
            <select id="source" class="select-source focus-ring fade">
              <option value="walk-in">Kh√°ch v√£ng lai</option>
              <option value="regular">Kh√°ch quen</option>
              <option value="online">Online</option>
            </select>
          </div>

          <!-- Kh√°ch h√†ng -->
          <div class="field">
            <label id="lblClient" class="flabel" for="client">Kh√°ch h√†ng</label>
            <input id="client" placeholder="T√™n kh√°ch (tu·ª≥ ch·ªçn)" class="client-input focus-ring fade" />
          </div>

          <!-- Ghi ch√∫ -->
          <div class="field">
            <label id="lblNote" class="flabel" for="note">Ghi ch√∫</label>
            <input id="note" placeholder="Kh√°ch / ca / ghi ch√∫‚Ä¶" class="note-input focus-ring fade" />
          </div>
        </div>

        <div class="dlg-foot">
          <button id="btnCancel" value="cancel" class="btnCancel focus-ring fade">H·ªßy</button>
          <button id="btnSave" value="default" class="btnSave focus-ring fade">L∆∞u</button>
        </div>
      </form>
    </dialog>

    <script>
      // ======= State & helpers =======
      const STORAGE_KEY = 'entries_v1';
      const entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const selectedIds = new Set();
      const sourceLabels = { 'walk-in': 'Kh√°ch v√£ng lai', regular: 'Kh√°ch quen', online: 'Online' };

      const els = {
        fab: document.getElementById('fab'),
        entries: document.getElementById('entries'),
        dlg: document.getElementById('entryDialog'),
        form: document.getElementById('entryForm'),
        entryId: document.getElementById('entryId'),
        amount: document.getElementById('amount'),
        inputDate: document.getElementById('inputDate'),
        recordTomorrow: document.getElementById('recordTomorrow'),
        intendedDate: document.getElementById('intendedDate'),
        intendedPreview: document.getElementById('intendedPreview'),
        source: document.getElementById('source'),
        client: document.getElementById('client'),
        note: document.getElementById('note'),

        // filters
        search: document.getElementById('search'),
        fromDate: document.getElementById('fromDate'),
        toDate: document.getElementById('toDate'),
        sort: document.getElementById('sort'),
        btnClearFilters: document.getElementById('btnClearFilters'),

        // bulk
        lblSelectedCount: document.getElementById('lblSelectedCount'),
        btnSelectAll: document.getElementById('btnSelectAll'),
        btnDeleteSelected: document.getElementById('btnDeleteSelected'),

        // summary labels
        lblToday: document.getElementById('lblToday'),
        lblTomorrow: document.getElementById('lblTomorrow'),
        lblThisWeek: document.getElementById('lblThisWeek'),
        lblThisMonth: document.getElementById('lblThisMonth'),
        sumToday: document.getElementById('sumToday'),
        sumTomorrow: document.getElementById('sumTomorrow'),
        sumWeek: document.getElementById('sumWeek'),
        sumMonth: document.getElementById('sumMonth'),
      };

      const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
      const pad2 = (n) => String(n).padStart(2, '0');
      const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
      const parseISO = (s) => { const [y, m, d] = s.split('-').map(Number); return new Date(y, m - 1, d); };
      const todayISO = () => toISO(new Date());
      const addDaysISO = (iso, days) => { const d = iso ? parseISO(iso) : new Date(); d.setDate(d.getDate() + days); return toISO(d); };
      const startOfWeekISO = (iso) => { const d = parseISO(iso); const day = d.getDay(); const diff = (day === 0 ? -6 : 1) - day; // Mon = 1
        d.setDate(d.getDate() + diff); return toISO(d); };
      const endOfWeekISO = (iso) => addDaysISO(startOfWeekISO(iso), 6);
      const startOfMonthISO = (iso) => { const d = parseISO(iso); d.setDate(1); return toISO(d); };
      const endOfMonthISO = (iso) => { const d = parseISO(iso); d.setMonth(d.getMonth() + 1, 0); return toISO(d); };

      const fmtVND = (n) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(Math.round(n || 0));

      function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

      // ======= Filters =======
      function normalize(s) { return (s || '').toString().toLowerCase(); }
      function passFilters(e) {
        const q = normalize(els.search.value);
        const f = els.fromDate.value || null;
        const t = els.toDate.value || null;
        const intended = e.intendedDate || e.inputDate;
        const hay = `${e.note || ''} ${e.client || ''} ${sourceLabels[e.source] || e.source || ''}`.toLowerCase();
        if (q && !hay.includes(q)) return false;
        if (f && intended < f) return false;
        if (t && intended > t) return false;
        return true;
      }

      function sortEntries(list) {
        const how = els.sort.value || 'newest';
        const byCreated = (a, b) => (b.createdAt || '').localeCompare(a.createdAt || '');
        const byAmountDesc = (a, b) => (b.amountVND || 0) - (a.amountVND || 0) || byCreated(a, b);
        const byAmountAsc = (a, b) => (a.amountVND || 0) - (b.amountVND || 0) || byCreated(a, b);
        const byOldest = (a, b) => (a.createdAt || '').localeCompare(b.createdAt || '');
        switch (how) {
          case 'amountDesc': return list.sort(byAmountDesc);
          case 'amountAsc': return list.sort(byAmountAsc);
          case 'oldest': return list.sort(byOldest);
          case 'newest':
          default: return list.sort(byCreated);
        }
      }

      // ======= Render 1 entry row =======
      function renderEntryRow(e) {
        const row = document.createElement('div');
        row.className = 'entry-row';

        const colDate = document.createElement('div');
        colDate.className = 'entry-col-date';
        colDate.innerHTML = `
          <div class="entry-date-main">${(e.intendedDate || e.inputDate || '').split('-').reverse().join('/')}</div>
          <div style="margin-top: 12px;">
            <input type="checkbox" class="entry-checkbox focus-ring fade" data-id="${e.id}" ${selectedIds.has(e.id) ? 'checked' : ''}>
          </div>
        `;

        const colMain = document.createElement('div');
        colMain.className = 'entry-col-main';
        const metaLeft = `
          <div class="entry-amount">${fmtVND(e.amountVND)}</div>
          <div class="entry-note">${[e.note, e.client].filter(Boolean).join(' ¬∑ ') || ''} ${e.source ? '¬∑ [' + (sourceLabels[e.source] || e.source) + ']' : ''}</div>
        `;
        const metaRight = `
          <div class="entry-meta">
            <span>Input: ${e.inputDate || ''}</span>
            <span>Intended: ${e.intendedDate || e.inputDate || ''}</span>
            <span>Saved: ${e.createdAt ? new Date(e.createdAt).toLocaleString('vi-VN') : ''}</span>
          </div>
        `;
        colMain.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px;flex:1">${metaLeft}${metaRight}</div>`;

        const colActions = document.createElement('div');
        colActions.className = 'entry-col-actions';

        const btnEdit = document.createElement('button');
        btnEdit.innerHTML = `‚úèÔ∏è S·ª≠a`;
        btnEdit.className = 'entry-btn entry-btn-edit';
        btnEdit.onclick = () => openForEdit(e.id);

        const btnDel = document.createElement('button');
        btnDel.innerHTML = `üóëÔ∏è Xo√°`;
        btnDel.className = 'entry-btn entry-btn-del';
        btnDel.onclick = () => {
          const idx = entries.findIndex((x) => x.id === e.id);
          if (idx >= 0) {
            entries.splice(idx, 1);
            selectedIds.delete(e.id);
            save();
            renderEverything();
          }
        };

        colActions.appendChild(btnEdit);
        colActions.appendChild(btnDel);

        row.appendChild(colDate);
        row.appendChild(colMain);
        row.appendChild(colActions);
        return row;
      }

      // ======= Render list (filtered + sorted) =======
      function renderList() {
        els.entries.innerHTML = '';
        const visible = sortEntries(entries.filter(passFilters));
        if (!visible.length) {
          const empty = document.createElement('div');
          empty.textContent = "Ch∆∞a c√≥ m·ª•c n√†o kh·ªõp b·ªô l·ªçc. Nh·∫•n '+ Th√™m tip'.";
          empty.style.cssText = 'text-align:center;color:#6b7280;margin-top:24px';
          els.entries.appendChild(empty);
        } else {
          visible.forEach((e) => els.entries.appendChild(renderEntryRow(e)));
        }
        // update bulk bar count based on currently visible selection
        updateSelectedCount();
      }

      // ======= Summaries =======
      function renderSummaries() {
        const today = todayISO();
        const tomorrow = addDaysISO(today, 1);
        const wStart = startOfWeekISO(today);
        const wEnd = endOfWeekISO(today);
        const mStart = startOfMonthISO(today);
        const mEnd = endOfMonthISO(today);

        const sum = { today: 0, tomorrow: 0, week: 0, month: 0 };
        for (const e of entries) {
          const d = e.intendedDate || e.inputDate;
          const a = e.amountVND || 0;
          if (d === today) sum.today += a;
          if (d === tomorrow) sum.tomorrow += a;
          if (d >= wStart && d <= wEnd) sum.week += a;
          if (d >= mStart && d <= mEnd) sum.month += a;
        }

        // Pretty labels with dates
        els.lblToday.textContent = `H√¥m nay (${today.split('-').reverse().join('/')})`;
        els.lblTomorrow.textContent = `Ng√†y mai (${tomorrow.split('-').reverse().join('/')})`;
        const wRange = `${wStart.split('-').reverse().join('/')} ‚Äì ${wEnd.split('-').reverse().join('/')}`;
        els.lblThisWeek.textContent = `Tu·∫ßn n√†y (${wRange})`;
        const [y, m] = today.split('-');
        els.lblThisMonth.textContent = `Th√°ng n√†y (${m}/${y})`;

        els.sumToday.textContent = fmtVND(sum.today);
        els.sumTomorrow.textContent = fmtVND(sum.tomorrow);
        els.sumWeek.textContent = fmtVND(sum.week);
        els.sumMonth.textContent = fmtVND(sum.month);
      }

      // ======= Modal logic =======
      function setIntendedByRule() {
        const base = els.inputDate.value || todayISO();
        const auto = els.recordTomorrow.checked ? addDaysISO(base, 1) : base;
        // only set if user hasn't manually overridden
        if (!els.intendedDate.dataset.manual) {
          els.intendedDate.value = auto;
        }
        els.intendedPreview.textContent = (els.intendedDate.value || auto).split('-').reverse().join('/');
      }

      function openForNew() {
        els.form.reset();
        els.entryId.value = '';
        els.amount.value = '';
        els.inputDate.value = todayISO();
        els.recordTomorrow.checked = true; // m·∫∑c ƒë·ªãnh
        els.intendedDate.value = '';
        delete els.intendedDate.dataset.manual;
        els.source.value = 'walk-in';
        els.client.value = '';
        els.note.value = '';
        setIntendedByRule();
        els.dlg.showModal();
        setTimeout(() => els.amount.focus(), 0);
      }

      function openForEdit(id) {
        const e = entries.find((x) => x.id === id);
        if (!e) return;
        els.entryId.value = e.id;
        els.amount.value = (e.amountVND || '').toLocaleString('vi-VN');
        els.inputDate.value = e.inputDate || todayISO();
        // Determine rule
        const autoIfTomorrow = addDaysISO(els.inputDate.value, 1);
        const intended = e.intendedDate || e.inputDate;
        if (intended === autoIfTomorrow) {
          els.recordTomorrow.checked = true;
          delete els.intendedDate.dataset.manual;
          els.intendedDate.value = '';
        } else if (intended === els.inputDate.value) {
          els.recordTomorrow.checked = false;
          delete els.intendedDate.dataset.manual;
          els.intendedDate.value = '';
        } else {
          els.recordTomorrow.checked = false; // user overrode
          els.intendedDate.value = intended;
          els.intendedDate.dataset.manual = '1';
        }
        els.source.value = e.source || 'walk-in';
        els.client.value = e.client || '';
        els.note.value = e.note || '';
        setIntendedByRule();
        els.dlg.showModal();
        setTimeout(() => els.amount.focus(), 0);
      }

      function upsert(obj) {
        const idx = entries.findIndex((x) => x.id === obj.id);
        if (idx >= 0) entries[idx] = obj; else entries.push(obj);
        save();
        renderEverything();
      }

      // ======= Bulk selection =======
      function updateSelectedCount() {
        // Count only selected that are currently visible in DOM
        const visibleIds = Array.from(document.querySelectorAll('.entry-checkbox')).map((c) => c.dataset.id);
        const n = visibleIds.filter((id) => selectedIds.has(id)).length;
        els.lblSelectedCount.textContent = `${n} m·ª•c ƒë√£ ch·ªçn`;
      }

      function toggleSelectAll() {
        const boxes = Array.from(document.querySelectorAll('.entry-checkbox'));
        const allChecked = boxes.length && boxes.every((b) => b.checked);
        boxes.forEach((b) => {
          b.checked = !allChecked;
          if (b.checked) selectedIds.add(b.dataset.id); else selectedIds.delete(b.dataset.id);
        });
        updateSelectedCount();
      }

      function deleteSelected() {
        if (!selectedIds.size) { alert('Ch∆∞a ch·ªçn m·ª•c n√†o.'); return; }
        if (!confirm('Xo√° t·∫•t c·∫£ m·ª•c ƒë√£ ch·ªçn?')) return;
        for (let i = entries.length - 1; i >= 0; i--) {
          if (selectedIds.has(entries[i].id)) entries.splice(i, 1);
        }
        selectedIds.clear();
        save();
        renderEverything();
      }

      // ======= Wiring =======
      els.fab.addEventListener('click', openForNew);

      // quick add buttons
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-quick]');
        if (!btn) return;
        const inc = Number(btn.getAttribute('data-quick')) || 0;
        const current = Number(String(els.amount.value).replace(/\D/g, '')) || 0;
        const next = current + inc;
        els.amount.value = next.toLocaleString('vi-VN');
        els.amount.dispatchEvent(new Event('input'));
      });

      // format amount typing
      els.amount.addEventListener('input', () => {
        const digits = String(els.amount.value).replace(/\D/g, '');
        els.amount.value = digits ? Number(digits).toLocaleString('vi-VN') : '';
      });

      // intended date logic
      els.inputDate.addEventListener('change', setIntendedByRule);
      els.recordTomorrow.addEventListener('change', setIntendedByRule);
      els.intendedDate.addEventListener('change', () => {
        if (els.intendedDate.value) {
          els.intendedDate.dataset.manual = '1';
        } else {
          delete els.intendedDate.dataset.manual;
        }
        setIntendedByRule();
      });

      // filters
      [els.search, els.fromDate, els.toDate, els.sort].forEach((el) => el.addEventListener('input', renderList));
      els.btnClearFilters.addEventListener('click', () => {
        els.search.value = '';
        els.fromDate.value = '';
        els.toDate.value = '';
        els.sort.value = 'newest';
        renderList();
      });

      // bulk bar
      els.btnSelectAll.addEventListener('click', toggleSelectAll);
      els.btnDeleteSelected.addEventListener('click', deleteSelected);

      // checkbox delegation
      els.entries.addEventListener('change', (ev) => {
        const box = ev.target.closest('.entry-checkbox');
        if (!box) return;
        if (box.checked) selectedIds.add(box.dataset.id); else selectedIds.delete(box.dataset.id);
        updateSelectedCount();
      });

      // submit form
      els.form.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const id = els.entryId.value || uid();
        const existing = entries.find((x) => x.id === id);
        const amount = Number(String(els.amount.value).replace(/\D/g, '')) || 0;
        if (!amount) {
          alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn.');
          return;
        }
        const inputDate = els.inputDate.value || todayISO();
        const intendedDate = (els.intendedDate.value || (els.recordTomorrow.checked ? addDaysISO(inputDate, 1) : inputDate));
        const obj = {
          id,
          createdAt: existing?.createdAt || new Date().toISOString(),
          inputDate,
          intendedDate,
          amountVND: amount,
          source: els.source.value || 'walk-in',
          client: els.client.value.trim(),
          note: els.note.value.trim(),
        };
        upsert(obj);
        els.dlg.close();
      });

      document.getElementById('btnCancel').addEventListener('click', (e) => {
        e.preventDefault();
        els.dlg.close();
      });

      function renderEverything() {
        renderList();
        renderSummaries();
      }

      // ======= First render =======
      renderEverything();
    </script>
  </body>
</html>
